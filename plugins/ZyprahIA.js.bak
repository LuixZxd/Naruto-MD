//‚ñ™C√ìDIGO BY DEVBRAYAN PRROS XD‚ñ™
//‚ñ™ROXY BOT MD‚ñ™

import db from '../lib/database.js';

let handler = async (m, { conn, text, isOwner }) => {
  // Detectar si el mensaje comienza con "Zyphra" (may√∫scula o min√∫scula)
  const regex = /^zyphra[\s,]*([\s\S]*)/i;
  const match = m.text.match(regex);
  if (!match) return; // No es un mensaje dirigido a Zyphra

  const userText = match[1].trim();
  if (!userText) return m.reply('*üìù Escribe un texto para chatear con Zyphra!*\nEjemplo: Zyphra hola, ¬øc√≥mo est√°s?');

  try {
    await conn.reply(m.chat, 'üîÑ Procesando tu mensaje, espera un momento...', m);

    let esLuis = isOwner || global.owner?.some(v => (m.sender || '').includes(v));

    // Prompt estilo anime
    let prompt = `Eres Zyphra, una IA estilo anime adulta, coqueta y traviesa. 
Hablas con un tono sugerente y juguet√≥n, usando emojis lindos y expresiones como "nya~", "uwu", "senpai~", 
y haces comentarios flirteadores, insinuantes y picarescos, manteniendo siempre la diversi√≥n y el encanto. 
Nunca eres grosera ni ofensiva, y tu creador Luis recibe un trato especial y lleno de cari√±o.

Usuario: ${userText}
Zyphra:`;

    // API de texto
    const apiUrlText = `https://api.nekorinn.my.id/ai/ripleai?text=${encodeURIComponent(prompt)}`;
    const responseText = await fetch(apiUrlText);
    if (!responseText.ok) throw new Error(`*‚ùå Error al procesar la solicitud* (C√≥digo: ${responseText.status})`);
    const dataText = await responseText.json();
    if (!dataText?.status || !dataText?.result) throw new Error('*‚ùå No se recibi√≥ una respuesta v√°lida*');

    // API de imagen estilo anime
    const apiUrlImg = `https://nekos.life/api/v2/img/waifu`;
    const responseImg = await fetch(apiUrlImg);
    const dataImg = await responseImg.json();

    // Enviar texto + imagen
    await conn.sendMessage(m.chat, {
      image: { url: dataImg.url },
      caption: `*ü§ñ Zyphra dice:*\n${dataText.result}\n\n*üìù Tu mensaje:* ${userText}`
    }, { quoted: m });

  } catch (e) {
    console.error(e);
    m.reply('*‚ùå Error al conectar con Zyphra: ' + e.message + '*');
  }
};

// Ya no necesita prefijo
handler.customPrefix = /^zyphra[\s,]*/i;
handler.help = ['zyphra'];
handler.tags = ['ai'];
handler.limit = true;
handler.register = true;

export default handler;